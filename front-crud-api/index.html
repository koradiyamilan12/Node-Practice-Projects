<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Student Records</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      padding: 24px;
      background: #f8f9fa;
    }

    .profile-thumb {
      width: 42px;
      height: 42px;
      object-fit: cover;
      border-radius: 50%;
    }

    .table-actions>button {
      margin-left: 6px;
    }

    .cursor-pointer {
      cursor: pointer;
    }

    .top-controls {
      gap: 12px;
    }

    .search-input {
      max-width: 420px;
    }

    .card-shadow {
      box-shadow: 0 6px 18px rgba(0, 0, 0, .06);
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="d-flex align-items-center justify-content-between mb-4">
      <h1 class="h3 mb-0">Student Records</h1>
      <div class="d-flex align-items-center top-controls">
        <input id="searchInput" type="search" class="form-control search-input"
          placeholder="Search by name, email, phone or gender">
        <button id="refreshBtn" class="btn btn-outline-secondary ms-2" title="Reset to sample data"
          onclick="fetchStudents()">Refresh</button>
        <button id="addStudentBtn" class="btn btn-primary ms-2" data-bs-toggle="modal"
          data-bs-target="#addEditModal">Add Student</button>
      </div>
    </div>

    <div class="card card-shadow">
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover mb-0 align-middle">
            <thead class="table-light">
              <tr>
                <th scope="col">Profile</th>
                <th scope="col">First name</th>
                <th scope="col">Last name</th>
                <th scope="col">Email</th>
                <th scope="col">Phone</th>
                <th scope="col">Gender</th>
                <th scope="col" class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody id="studentsTbody">

            </tbody>
          </table>
        </div>
      </div>
    </div>

    <nav>
      <ul class="pagination" id="pagination"></ul>
    </nav>

    <!-- Add/Edit Modal -->
    <div class="modal fade" id="addEditModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <form id="addEditForm" class="needs-validation" novalidate enctype="multipart/form-data">
            <div class="modal-header">
              <h5 class="modal-title" id="addEditModalTitle">Add Student</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="row g-3">
                <div class="col-12 col-md-4 text-center">
                  <div class="mb-3">
                    <img id="profilePreview" src="" alt="Profile preview" class="rounded-circle mb-2"
                      style="width:120px;height:120px;object-fit:cover;background:#e9ecef;">
                    <div>
                      <input id="profileFile" name="profile_pic" accept="image/*" type="file"
                        class="form-control form-control-sm" />
                    </div>
                    <small class="text-muted">Optional. Max 2 MB</small>
                    <div>
                      <button id="clearProfileBtn" class="btn btn-sm btn-outline-danger mt-2"
                        type="button">Clear</button>
                    </div>
                  </div>
                </div>

                <div class="col-12 col-md-8">
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label">First name</label>
                      <input id="firstName" class="form-control" name="first_name" />
                      <div class="invalid-feedback">First name required</div>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Last name</label>
                      <input id="lastName" class="form-control" name="last_name" />
                      <div class="invalid-feedback">Last name required</div>
                    </div>
                    <div class="col-md-8">
                      <label class="form-label">Email</label>
                      <input id="email" type="email" class="form-control" name="email" />
                      <div class="invalid-feedback">Valid email required</div>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Phone</label>
                      <input id="phone" class="form-control" name="phone" />
                      <div class="invalid-feedback">Phone required</div>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Gender</label>
                      <select id="gender" class="form-select" name="gender">
                        <option value="">Select gender</option>
                        <option value="Female">Female</option>
                        <option value="Male">Male</option>
                        <option value="Other">Other</option>
                      </select>
                      <div class="invalid-feedback">Choose gender</div>
                    </div>
                    <!-- <div class="col-md-6">
                      <label class="form-label">Notes</label>
                      <input id="notes" class="form-control" placeholder="Optional notes" />
                    </div> -->
                  </div>
                </div>
              </div>

              <input type="hidden" id="editingId" value="">
            </div>

            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button id="saveStudentBtn" type="submit" class="btn btn-primary">Save</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- View Modal -->
    <div class="modal fade" id="viewModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">View Student</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="text-center mb-3">
              <img id="viewProfile" src="" alt="profile" class="rounded-circle"
                style="width:120px;height:120px;object-fit:cover;background:#e9ecef;">
            </div>
            <dl class="row">
              <dt class="col-sm-4">First name</dt>
              <dd class="col-sm-8" id="viewFirst"></dd>
              <dt class="col-sm-4">Last name</dt>
              <dd class="col-sm-8" id="viewLast"></dd>
              <dt class="col-sm-4">Email</dt>
              <dd class="col-sm-8" id="viewEmail"></dd>
              <dt class="col-sm-4">Phone</dt>
              <dd class="col-sm-8" id="viewPhone"></dd>
              <dt class="col-sm-4">Gender</dt>
              <dd class="col-sm-8" id="viewGender"></dd>
              <!-- <dt class="col-sm-4">Notes</dt>
              <dd class="col-sm-8" id="viewNotes"></dd>
              <dt class="col-sm-4">ID</dt>
              <dd class="col-sm-8" id="viewId"></dd> -->
            </dl>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-light" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Bootstrap 5 JS & dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const apiUrl = "http://localhost:3000/api/students"
    const uploadsBase = "http://localhost:3000/uploads" // base for profile images
    let currentPage = 1
    let currentSearch = ""

    const placeholderProfile = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='120' height='120'><rect width='100%' height='100%' fill='%23e9ecef'/></svg>"

    // DOM refs
    const tbody = document.querySelector("#studentsTbody")
    const searchInput = document.querySelector("#searchInput")
    const addEditForm = document.querySelector("#addEditForm")
    const profileFile = document.querySelector("#profileFile")
    const profilePreview = document.querySelector("#profilePreview")
    const clearProfileBtn = document.querySelector("#clearProfileBtn")
    const saveBtn = document.querySelector("#saveStudentBtn")
    const addEditModalEl = document.querySelector("#addEditModal")
    const addEditModal = new bootstrap.Modal(addEditModalEl)
    const editingIdInput = document.querySelector("#editingId")
    const addEditModalTitle = document.querySelector("#addEditModalTitle")

    // Utility: safe text for inserting into table cells (prevents accidental HTML injection)
    function esc(text) {
      if (text === null || text === undefined) return ""
      return String(text).replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;")
    }

    // Fetch & render students
    async function fetchStudents(search = "", page = 1) {
      try {

        currentPage = page
        currentSearch = search

        const res = await fetch(`${apiUrl}?search=${encodeURIComponent(search)}&page=${page}&limit=5`)

        if (!res.ok) throw new Error(`Failed to load students: ${res.status}`)
        const data = await res.json()


        // Expecting data.students array. If your API returns differently, adapt here.
        const students = Array.isArray(data.students) ? data.students : (Array.isArray(data) ? data : [])
        tbody.innerHTML = ""
        students.forEach(student => {
          const imgSrc = student.profile_pic ? `${uploadsBase}/${student.profile_pic}` : placeholderProfile
          tbody.innerHTML += `
          <tr>
            <td><img src="${esc(imgSrc)}" class="rounded-circle" width="50" height="50" style="object-fit:cover" onerror="this.src='${placeholderProfile}'" /></td>
            <td>${esc(student.first_name)}</td>
            <td>${esc(student.last_name)}</td>
            <td>${esc(student.email)}</td>
            <td>${esc(student.phone)}</td>
            <td>${esc(student.gender)}</td>
            <td class="text-end">
              <button class="btn btn-sm btn-outline-primary" onclick="viewStudent('${student._id}')">View</button>
              <button class="btn btn-sm btn-outline-success" onclick="editStudent('${student._id}')">Edit</button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteStudent('${student._id}')">Delete</button>
            </td>
          </tr>
        `
        })

        renderPagination(data.totalPage)

      } catch (err) {
        console.error(err)
        tbody.innerHTML = `<tr><td colspan="7" class="text-danger">Failed to load students.</td></tr>`
      }
    }

    function renderPagination(totalPages) {
      const container = document.querySelector("#pagination")
      container.innerHTML = ""

      for (let i = 1; i <= totalPages; i++) {
        const li = document.createElement("li")
        li.className = "page-item" + (i === currentPage ? "active" : "")
        li.innerHTML = `<a class="page-link" href="#">${i}</a>`
        li.addEventListener("click", (e) => {
          e.preventDefault()
          fetchStudents(currentSearch, i)
        })
        container.appendChild(li)
      }
    }

    // initial load
    fetchStudents()

    // View student (unchanged, but with fallback)
    async function viewStudent(id) {
      try {
        const res = await fetch(`${apiUrl}/${id}`)
        if (!res.ok) throw new Error("Failed to fetch student")
        const data = await res.json()
        const student = data.student || data
        document.querySelector("#viewProfile").src = student.profile_pic ? `${uploadsBase}/${student.profile_pic}` : placeholderProfile
        document.querySelector("#viewFirst").textContent = student.first_name || ""
        document.querySelector("#viewLast").textContent = student.last_name || ""
        document.querySelector("#viewEmail").textContent = student.email || ""
        document.querySelector("#viewPhone").textContent = student.phone || ""
        document.querySelector("#viewGender").textContent = student.gender || ""
        new bootstrap.Modal(document.querySelector("#viewModal")).show()
      } catch (err) {
        console.error(err)
        alert("Unable to load student details.")
      }
    }

    // Search handler (debounce would be nice; keeping simple)
    searchInput.addEventListener("input", () => {
      fetchStudents(searchInput.value.trim())
    })

    // File preview + size check
    profileFile.addEventListener("change", (e) => {
      const f = e.target.files[0]
      if (!f) {
        profilePreview.src = placeholderProfile
        return
      }
      const maxBytes = 2 * 1024 * 1024 // 2 MB
      if (f.size > maxBytes) {
        alert("Profile picture must be 2 MB or smaller.")
        profileFile.value = ""
        profilePreview.src = placeholderProfile
        return
      }
      const reader = new FileReader()
      reader.onload = () => profilePreview.src = reader.result
      reader.readAsDataURL(f)
    })

    clearProfileBtn.addEventListener("click", () => {
      profileFile.value = ""
      profilePreview.src = placeholderProfile
    })

    // Reset modal when hidden
    addEditModalEl.addEventListener("hidden.bs.modal", () => {
      addEditForm.reset()
      editingIdInput.value = ""
      profilePreview.src = placeholderProfile
      addEditModalTitle.textContent = "Add Student"
      // remove validation classes if any
      addEditForm.classList.remove("was-validated")
    })

    // Populate form for editing
    async function editStudent(id) {
      try {
        const res = await fetch(`${apiUrl}/${id}`)
        if (!res.ok) throw new Error("Failed to fetch student for edit")
        const data = await res.json()
        const s = data.student || data
        document.querySelector("#firstName").value = s.first_name || ""
        document.querySelector("#lastName").value = s.last_name || ""
        document.querySelector("#email").value = s.email || ""
        document.querySelector("#phone").value = s.phone || ""
        document.querySelector("#gender").value = s.gender || ""
        editingIdInput.value = s._id || id
        profilePreview.src = s.profile_pic ? `${uploadsBase}/${s.profile_pic}` : placeholderProfile
        addEditModalTitle.textContent = "Edit Student"
        addEditModal.show()
        fetchStudents()
      } catch (err) {
        console.error(err)
        alert("Unable to load student for editing.")
      }
    }

    // Delete student (confirm)
    async function deleteStudent(id) {
      if (!confirm("Delete this student?")) return
      try {
        const res = await fetch(`${apiUrl}/${id}`, { method: "DELETE" })
        if (!res.ok) throw new Error("Delete failed")
        fetchStudents()
      } catch (err) {
        console.error(err)
        alert("Unable to delete student.")
      }
    }

    // Add / Edit submit handler
    addEditForm.addEventListener("submit", async function (e) {
      e.preventDefault()

      // basic client-side validation (Bootstrap custom)
      this.classList.add("was-validated")
      // Example checks
      if (!document.querySelector("#firstName").value.trim()) return
      if (!document.querySelector("#lastName").value.trim()) return
      if (!document.querySelector("#email").value.trim()) return
      if (!document.querySelector("#phone").value.trim()) return
      if (!document.querySelector("#gender").value) return

      const fd = new FormData(this) // <-- fixed: pass the form element itself
      const editingId = editingIdInput.value.trim()
      const method = editingId ? "PUT" : "POST"
      const url = editingId ? `${apiUrl}/${editingId}` : apiUrl

      // If user cleared profile input but server expects an explicit removal flag, you could add:
      // if (!profileFile.value && editingId) fd.append("remove_profile", "1")

      try {
        saveBtn.disabled = true
        saveBtn.textContent = editingId ? "Updating..." : "Saving..."
        const res = await fetch(url, {
          method,
          body: fd
        })
        if (!res.ok) {
          const text = await res.text().catch(() => "")
          throw new Error(`Server error: ${res.status} ${text}`)
        }
        // success
        addEditModal.hide()
        fetchStudents(searchInput.value.trim())
      } catch (err) {
        console.error(err)
        alert("Error saving student. See console for details.")
      } finally {
        saveBtn.disabled = false
        saveBtn.textContent = "Save"
      }
    })

    // Expose some functions to global scope so inline onclick in table can find them
    window.viewStudent = viewStudent
    window.editStudent = editStudent
    window.deleteStudent = deleteStudent
  </script>

</body>

</html>